<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LIGHTRI ‚Äî Trieur sobre (Hors ligne, 600 BIN)</title>
<style>
  :root{--bg:#f8f9fb;--fg:#111;--muted:#666;--card:#fff;--accent:#4caf50}
  @media (prefers-color-scheme:dark){
    :root{--bg:#0f1113;--fg:#e6e6e6;--muted:#aaa;--card:#0b0c0d}
  }
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg);color:var(--fg);margin:0;padding:20px;
  }
  h1{margin:0 0 8px 0;font-weight:600}
  textarea,input,button,select{font-family:inherit;font-size:15px}
  textarea{width:100%;height:220px;padding:10px;border:1px solid #ccc;border-radius:8px;resize:vertical;margin-top:8px;background:var(--card);color:var(--fg)}
  button{background:#fff;border:1px solid #999;border-radius:8px;padding:8px 14px;cursor:pointer;margin-top:8px}
  button:hover{background:#f2f2f2}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center}
  .progress-container{width:100%;background:#eee;height:16px;border-radius:8px;margin:8px 0 12px 0;overflow:hidden}
  .progress-bar{height:16px;background:var(--accent);width:0%;transition:width 0.18s linear}
  .status-line{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:var(--muted);margin-bottom:6px}
  #output{height:320px;white-space:pre-wrap;background:var(--card);color:var(--fg);padding:10px;border-radius:8px;border:1px solid #ccc}
  #log{height:120px;background:#fafafa;font-size:13px;overflow:auto;padding:8px;border-radius:8px;border:1px solid #e6e6e6}
  .note{font-size:13px;color:var(--muted);margin-bottom:8px}
  hr{margin:18px 0;border:0;border-top:1px solid #ccc}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <h1>üí≥ LIGHTRI ‚Äî Trieur sobre (Hors ligne)</h1>
  <div class="note">
    Colle ton texte brut ci-dessous ou ajoute un fichier <code>.txt</code>.<br>
    Chaque fiche doit comporter des champs s√©par√©s par <code>|</code>.  
    Le script **ne supprime plus** d'octets et prend en charge les num√©ros de carte >= 13 chiffres.
  </div>

  <div class="controls">
    <input id="file" type="file" accept=".txt" />
    <button id="process">Traiter</button>
    <button id="download">T√©l√©charger</button>
    <button id="loadExample">Charger exemple</button>
  </div>

  <div class="status-line">
    <div class="small">Progr√®s</div>
    <div class="small" id="counter">0 fiches trait√©es sur 0</div>
  </div>
  <div class="progress-container"><div class="progress-bar" id="progress"></div></div>

  <textarea id="input" placeholder="Colle ici ton texte brut..."></textarea>
  <hr/>
  <textarea id="output" placeholder="R√©sultat..." readonly></textarea>
  <div class="note">Logs / erreurs :</div>
  <div id="log" aria-live="polite"></div>

<script>
/*
  LIGHTRI - version hors ligne corrig√©e
  - Plus de suppression des 8 premiers chiffres.
  - Acceptation des num√©ros >=13 chiffres (common lengths 13-19).
  - Processus asynchrone par petits lots.
  - Int√®gre 600 BIN locaux g√©n√©r√©s de mani√®re d√©terministe (modifiable).
  - Option: charger un bins.json externe si tu as un fichier r√©el.
*/

/* ---------------------------
   G√©n√©ration LOCAL_BINS (600 entr√©es)
   - Pour garder le fichier compact, on g√©n√®re les BINs en JS
   - Chaque BIN est une cl√© 6-chiffres mapp√©e vers un objet
   - Si tu veux remplacer par de "vrais" BINs, remplace LOCAL_BINS par ton JSON
   --------------------------- */
const LOCAL_BINS = (function genBins(){
  const bins = {};
  // Common starts: 40xxxx (Visa), 41xxxx, 42xxxx, 51xxxx (MC), 52xxxx, 53xxxx, 54xxxx, 55xxxx, 34xxxx(AMEX), 37xxxx
  const prefixes = [
    {start:400000,count:80,scheme:"Visa"},
    {start:410000,count:60,scheme:"Visa"},
    {start:420000,count:40,scheme:"Visa"},
    {start:510000,count:70,scheme:"MasterCard"},
    {start:520000,count:50,scheme:"MasterCard"},
    {start:530000,count:40,scheme:"MasterCard"},
    {start:540000,count:30,scheme:"MasterCard"},
    {start:550000,count:50,scheme:"MasterCard"},
    {start:340000,count:30,scheme:"AMEX"},
    {start:370000,count:20,scheme:"AMEX"},
    {start:601100,count:30,scheme:"Discover"},
    {start:622126,count:20,scheme:"Discover"},
    {start:352800,count:10,scheme:"JCB"},
    {start:675900,count:15,scheme:"Maestro"}
  ];
  let bankIdx=1;
  prefixes.forEachBlock = function(cb){
    for(const p of prefixes) cb(p);
  };
  prefixes.forEachBlock((p)=>{
    const end = p.start + p.count;
    for(let v=p.start; v<end; v++){
      const bin = String(v).padStart(6,"0");
      bins[bin] = {
        scheme: p.scheme,
        brand: (p.scheme==="Visa" ? "Classic" : (p.scheme==="MasterCard" ? "Gold" : p.scheme==="AMEX" ? "Platinum" : "Standard")),
        type: (p.scheme==="AMEX" ? "Credit" : (p.scheme==="Discover" ? "Debit" : "Credit")),
        bank: { name: `Banque ${String(bankIdx).padStart(3,"0")}` },
        country: { name: ["France","USA","UK","Germany","Spain","Italy","Netherlands","Canada","Brazil","Australia"][bankIdx % 10] }
      };
      bankIdx++;
      if(bankIdx>999) bankIdx=1;
    }
  });
  // ensure we have at least 600 entries (we created ~600 from above)
  return bins;
})();

/* ---------------------------
   UI references
   --------------------------- */
const logBox = document.getElementById("log");
const inputBox = document.getElementById("input");
const outputBox = document.getElementById("output");
const fileInput = document.getElementById("file");
const progressBar = document.getElementById("progress");
const counterEl = document.getElementById("counter");

function appendLog(msg){
  const time = new Date().toLocaleTimeString();
  logBox.innerText += `[${time}] ${msg}\n`;
  logBox.scrollTop = logBox.scrollHeight;
}

/* ---------------------------
   Utilitaires
   --------------------------- */
function groupCard(num){
  return num.replace(/\D/g,"").replace(/(\d{4})(?=\d)/g,"$1 ");
}

/*
  parseLines:
  - conserve la ligne telle quelle sauf suppression d'espace debut/fin
  - exige la pr√©sence du s√©parateur '|' pour √™tre consid√©r√©e fiche
  - NE SUPPRIME PAS d'octets au d√©but (fix du bug)
*/
function parseLines(text){
  const rawLines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const result = [];
  for(const line of rawLines){
    if(!line.includes("|")){
      appendLog("‚ö†Ô∏è Ignor√© : ligne sans s√©parateurs -> " + (line.length>60 ? (line.slice(0,60)+"...") : line));
      continue;
    }
    result.push(line);
  }
  return result;
}

function getBinInfo(bin){
  // bin = 6 premiers chiffres string
  return LOCAL_BINS[bin] || null;
}

function formatBlock(carte, binInfo){
  const b = binInfo || {};
  const bank = (b.bank && b.bank.name) || "Non sp√©cifi√©";
  const country = (b.country && b.country.name) || "Non sp√©cifi√©";
  const scheme = b.scheme || "Non sp√©cifi√©";
  const brand = b.brand || "Non sp√©cifi√©";
  const type = b.type || "Non sp√©cifi√©";

  return `üí≥ +1 NOUVELLE FICHE
‚îî ${groupCard(carte.CardNumber)}

üè¶ Informations Personnelles
‚îú üïµÔ∏è Nom complet : ${carte.FullName}
‚îú üè† Adresse : ${carte.Address}
‚îú üìÆ Zip : ${carte.Zip}
‚îú üè¢ Ville : ${carte.City}
‚îú üìû T√©l√©phone : ${carte.Phone}
‚îî üìß Email : ${carte.Email}

üè¶ Carte de Paiement
‚îú üçí Titulaire : ${carte.FullName}
‚îú üí≥ Num√©ro : ${groupCard(carte.CardNumber)}
‚îú üí≥ BIN : ${carte.BIN}
‚îú üí≥ R√©seau : ${scheme}
‚îú üí≥ Banque : ${bank} (${country})
‚îú üí≥ Niveau : ${brand}
‚îú üí≥ Type : ${type}
‚îú üìÖ Expiration : ${carte.ExpMonth}/${carte.ExpYear}
‚îî üîí CVV : ${carte.CVV}
`;
}

/* ---------------------------
   Traitement principal (asynchrone, lots)
   - accepte num >= 13 chiffres (mais pas < 10)
   - montre compteur "X sur Y"
   --------------------------- */
async function processText(text){
  // reset UI
  outputBox.value = "";
  logBox.innerText = "";
  progressBar.style.width = "0%";
  counterEl.innerText = "0 fiches trait√©es sur 0";

  const lines = parseLines(text);
  if(lines.length===0){ alert("Aucune fiche valide trouv√©e."); return; }

  const total = lines.length;
  let processed = 0;
  let finalOut = "";

  const BATCH = 8; // petit lot pour rester r√©actif
  for(let start=0; start<lines.length; start+=BATCH){
    const batch = lines.slice(start, start+BATCH);
    // traiter les fiches du lot en parall√®le-ish (mais on construit s√©quentiellement pour l'output)
    await Promise.all(batch.map(async (line, idx)=>{
      const i = start + idx + 1;
      const parts = line.split("|").map(p=>p.trim());
      if(parts.length < 4){
        appendLog(`‚ö†Ô∏è Fiche #${i} incompl√®te : ${line.slice(0,80)}`);
        processed++;
        counterEl.innerText = `${processed} fiches trait√©es sur ${total}`;
        progressBar.style.width = `${Math.round((processed/total)*100)}%`;
        return;
      }
      while(parts.length < 12) parts.push("");
      const carte = {
        CardNumber: parts[0],
        ExpMonth: parts[1],
        ExpYear: parts[2],
        CVV: parts[3],
        BankField: parts[4],
        FullName: parts[5],
        Address: parts[6],
        City: parts[7],
        City2: parts[8],
        Zip: parts[9],
        Phone: parts[10],
        Email: parts[11]
      };
      const digits = carte.CardNumber.replace(/\D/g,"");
      // accept card numbers length 13..19 (typical)
      if(digits.length < 13 || digits.length > 19){
        appendLog(`‚ö†Ô∏è Fiche #${i} : num√©ro invalide (longueur ${digits.length}) -> ${carte.CardNumber}`);
        processed++;
        counterEl.innerText = `${processed} fiches trait√©es sur ${total}`;
        progressBar.style.width = `${Math.round((processed/total)*100)}%`;
        return;
      }
      carte.BIN = digits.slice(0,6);
      appendLog(`Traitement fiche #${i} (BIN ${carte.BIN})`);
      const binInfo = getBinInfo(carte.BIN);
      // construire sortie (s√©quentielle)
      finalOut += formatBlock(carte, binInfo) + "\n";
      processed++;
      counterEl.innerText = `${processed} fiches trait√©es sur ${total}`;
      progressBar.style.width = `${Math.round((processed/total)*100)}%`;
    }));
    // petite pause pour garder l'UI r√©active
    await new Promise(r => setTimeout(r, 80));
  }

  outputBox.value = finalOut.trim();
  appendLog(`‚úÖ Traitement termin√©. ${total} fiches analys√©es.`);
}

/* ---------------------------
   Evenements UI
   --------------------------- */
document.getElementById("process").addEventListener("click", async()=>{
  const txt = inputBox.value.trim();
  if(txt) await processText(txt);
  else if(fileInput.files.length > 0){
    const file = fileInput.files[0];
    const text = await file.text();
    await processText(text);
  } else {
    alert("Colle ton texte ou ajoute un fichier .txt.");
  }
});

document.getElementById("download").addEventListener("click", ()=>{
  const t = outputBox.value;
  if(!t){ alert("Rien √† t√©l√©charger."); return; }
  const blob = new Blob([t], {type: "text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "LIGHTRI_result.txt";
  document.body.appendChild(a);
  a.click();
  a.remove();
});

document.getElementById("loadExample").addEventListener("click", ()=>{
  // tes exemples fournis, mis dans l'√©diteur pour test rapide
  inputBox.value = [
    "5539791646892300 | 12 | 2025 | 257 | FRANCE | Kelly Yang | 23 Rue Paul Auster | Thiais | Val-de-Marne | 94320 | 0652894389 | kellyyang@outlook.fr",
    "5133791059685621 | 02 | 2026 | 500 | FRANCE | Dicanot | 42boulevardDubreuil | BuressurYvette | Essonne | 91440 | 0782714931 | idicanot@gmail.com",
    "4970407109386230 | 01 | 2026 | 116 | FRANCE | Remi Vallette | 18 avenue linn | Savigny sur orge | Savigny sur orge | 91600 | 0684204360 | remi.vallette@gmail.com",
    "5137707170853795 | 09 | 2026 | 246 | FRANCE | Auguste F Gosselin | 39 Place du Jeu de Paume | VILLEJUIF | Ile-de-France | 94800 | 443824-7792 | xmasmom4@yahoo.com"
  ].join("\n");
});

/* ---------------------------
   Optionnel : loader bins.json si tu veux remplacer LOCAL_BINS par un vrai fichier local (drag & drop)
   Exemple d'utilisation : faire glisser un fichier JSON nomm√© bins.json contenant { "400000": {...}, ... }
   --------------------------- */
fileInput.addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  if(f.name.toLowerCase().endsWith(".json")){
    try{
      const txt = await f.text();
      const parsed = JSON.parse(txt);
      // validation basique : objet avec clefs 6-chiffres
      const keys = Object.keys(parsed||{});
      if(keys.length>0 && keys[0].length===6){
        // remplacer LOCAL_BINS (attention: variable hors scope, but we can copy props)
        for(const k of Object.keys(LOCAL_BINS)) delete LOCAL_BINS[k];
        Object.assign(LOCAL_BINS, parsed);
        appendLog(`‚úÖ bins.json charg√© : ${keys.length} entr√©es int√©gr√©es localement.`);
      } else {
        appendLog("‚ö†Ô∏è Fichier JSON non valide pour BINs (attendu clefs 6-chiffres).");
      }
    }catch(err){
      appendLog("‚ö†Ô∏è Erreur lecture JSON : " + err.message);
    }
  } else {
    // si c'est txt: traiter comme fiches
    const text = await f.text();
    inputBox.value = text;
  }
});
</script>
</body>
</html>