<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LIGHTRI — Trieur sobre (Hors ligne)</title>
<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:#f8f9fb;color:#111;margin:0;padding:20px;
}
h1{margin-top:0;font-weight:600}
textarea,input,button{
  font-family:inherit;font-size:15px
}
textarea{
  width:100%;height:240px;padding:10px;border:1px solid #ccc;
  border-radius:8px;resize:vertical;margin-top:8px
}
button{
  background:#fff;border:1px solid #999;border-radius:8px;
  padding:8px 16px;cursor:pointer;margin-top:8px
}
button:hover{background:#f2f2f2}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
#output{height:340px;white-space:pre-wrap}
#log{height:140px;background:#fafafa;font-size:13px;overflow:auto}
.note{font-size:13px;color:#444;margin-bottom:8px}
.progress-container{width:100%;background:#eee;height:16px;border-radius:8px;margin-bottom:12px;overflow:hidden;}
.progress-bar{height:16px;background:#4caf50;width:0%;transition:width 0.2s;}
hr{margin:20px 0;border:0;border-top:1px solid #ccc}
</style>
</head>
<body>
<h1>💳 LIGHTRI — Trieur sobre (Hors ligne)</h1>
<div class="note">
Colle ton texte brut ci-dessous ou ajoute un fichier .txt.<br/>
Chaque fiche doit comporter des champs séparés par <code>|</code>.<br/>
Le script supprime les 8 premiers chiffres d’identifiant avant chaque fiche.
</div>

<div class="controls">
  <input id="file" type="file" accept=".txt" />
  <button id="process">Traiter</button>
  <button id="download">Télécharger</button>
</div>

<div class="progress-container"><div class="progress-bar" id="progress"></div></div>

<textarea id="input" placeholder="Colle ici ton texte brut..."></textarea>
<hr/>
<textarea id="output" placeholder="Résultat..." readonly></textarea>
<div class="note">Logs / erreurs :</div>
<textarea id="log" readonly></textarea>

<script>
// --- Base BIN locale exemple ---
const LOCAL_BINS = {
  "400000": {scheme:"Visa",brand:"Classic",type:"Debit",bank:{name:"Bank A"},country:{name:"USA"}},
  "510000": {scheme:"MasterCard",brand:"Gold",type:"Credit",bank:{name:"Bank B"},country:{name:"France"}},
  "340000": {scheme:"AMEX",brand:"Platinum",type:"Credit",bank:{name:"Bank C"},country:{name:"UK"}}
};

const logBox = document.getElementById("log");
const inputBox = document.getElementById("input");
const outputBox = document.getElementById("output");
const fileInput = document.getElementById("file");
const progressBar = document.getElementById("progress");

function log(msg){
  logBox.value += msg + "\n"; 
  logBox.scrollTop = logBox.scrollHeight; 
}

function fetchBinLocal(bin){
  return LOCAL_BINS[bin] || null;
}

function parseLines(text){
  const rawLines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const result = [];
  for(const line of rawLines){
    const cleaned = line.replace(/^\d{8,}\s*/, "");
    if(!cleaned.includes("|")){
      log("⚠️ Ignoré : ligne sans séparateurs -> "+cleaned);
      continue;
    }
    result.push(cleaned);
  }
  return result;
}

function groupCard(num){
  return num.replace(/\D/g,"").replace(/(\d{4})(?=\d)/g,"$1 ");
}

function formatBlock(carte, binInfo){
  const b = binInfo || {};
  const bank = (b.bank && b.bank.name) || "Non spécifié";
  const country = (b.country && b.country.name) || "Non spécifié";
  const scheme = b.scheme || "Non spécifié";
  const brand = b.brand || "Non spécifié";
  const type = b.type || "Non spécifié";

  return `💳 +1 NOUVELLE FICHE
└ ${groupCard(carte.CardNumber)}

🏦 Informations Personnelles
├ 🕵️ Nom complet : ${carte.FullName}
├ 🏠 Adresse : ${carte.Address}
├ 📮 Zip : ${carte.Zip}
├ 🏢 Ville : ${carte.City}
├ 📞 Téléphone : ${carte.Phone}
└ 📧 Email : ${carte.Email}

🏦 Carte de Paiement
├ 🍒 Titulaire : ${carte.FullName}
├ 💳 Numéro : ${groupCard(carte.CardNumber)}
├ 💳 BIN : ${carte.BIN}
├ 💳 Réseau : ${scheme}
├ 💳 Banque : ${bank} (${country})
├ 💳 Niveau : ${brand}
├ 💳 Type : ${type}
├ 📅 Expiration : ${carte.ExpMonth}/${carte.ExpYear}
└ 🔒 CVV : ${carte.CVV}
`;
}

async function processText(text){
  logBox.value = ""; outputBox.value = "";
  progressBar.style.width = "0%";

  const lines = parseLines(text);
  if(lines.length===0){ alert("Aucune fiche valide trouvée."); return; }

  let finalOut = "";
  let i=0;
  for(const line of lines){
    i++;
    const parts = line.split("|").map(p=>p.trim());
    if(parts.length<4){ log("⚠️ Fiche #"+i+" incomplète : "+line); continue; }
    while(parts.length<12) parts.push("");
    const carte={
      CardNumber:parts[0],ExpMonth:parts[1],ExpYear:parts[2],CVV:parts[3],
      BankField:parts[4],FullName:parts[5],Address:parts[6],
      City:parts[7],City2:parts[8],Zip:parts[9],Phone:parts[10],Email:parts[11]
    };
    const digits = carte.CardNumber.replace(/\D/g,"");
    if(digits.length<6){ log("⚠️ Fiche #"+i+" carte trop courte."); continue; }
    carte.BIN = digits.slice(0,6);
    log("Traitement fiche #"+i+" (BIN "+carte.BIN+")...");
    const binInfo = fetchBinLocal(carte.BIN);
    finalOut += formatBlock(carte,binInfo) + "\n";

    progressBar.style.width = `${Math.round((i/lines.length)*100)}%`;
    await new Promise(r=>setTimeout(r,50));
  }

  outputBox.value = finalOut.trim();
  log("✅ Traitement terminé. "+lines.length+" fiches analysées.");
}

document.getElementById("process").addEventListener("click", async()=>{
  const txt = inputBox.value.trim();
  if(txt) await processText(txt);
  else if(fileInput.files.length>0){
    const file = fileInput.files[0];
    const text = await file.text();
    await processText(text);
  }else alert("Colle ton texte ou ajoute un fichier .txt.");
});

document.getElementById("download").addEventListener("click",()=>{
  const t = outputBox.value;
  if(!t){ alert("Rien à télécharger."); return; }
  const blob = new Blob([t],{type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "LIGHTRI_result.txt";
  document.body.appendChild(a);
  a.click();
  a.remove();
});
</script>
</body>
</html>