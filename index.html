<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LIGHTRI â€” Trieur sobre</title>
<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:#f8f9fb;color:#111;margin:0;padding:20px;
}
h1{margin-top:0;font-weight:600}
textarea,input,button{
  font-family:inherit;font-size:15px
}
textarea{
  width:100%;height:240px;padding:10px;border:1px solid #ccc;
  border-radius:8px;resize:vertical;margin-top:8px
}
button{
  background:#fff;border:1px solid #999;border-radius:8px;
  padding:8px 16px;cursor:pointer;margin-top:8px
}
button:hover{background:#f2f2f2}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
#output{height:340px;white-space:pre-wrap}
#log{height:140px;background:#fafafa;font-size:13px;overflow:auto}
.note{font-size:13px;color:#444;margin-bottom:8px}
hr{margin:20px 0;border:0;border-top:1px solid #ccc}
</style>
</head>
<body>
<h1>ðŸ’³ LIGHTRI â€” Trieur sobre</h1>
<div class="note">Colle ton texte brut ci-dessous ou ajoute un fichier .txt.  
Chaque fiche doit comporter des champs sÃ©parÃ©s par <code>|</code>.  
Le script supprime les 8 premiers chiffres dâ€™identifiant avant chaque fiche.</div>

<div class="controls">
  <input id="file" type="file" accept=".txt" />
  <button id="process">Traiter</button>
  <button id="download">TÃ©lÃ©charger</button>
</div>

<textarea id="input" placeholder="Colle ici ton texte brut..."></textarea>
<hr/>
<textarea id="output" placeholder="RÃ©sultat..." readonly></textarea>
<div class="note">Logs / erreurs :</div>
<textarea id="log" readonly></textarea>

<script>
const API_BASE = "https://celebrated-strudel-1c13f6.netlify.app/.netlify/functions/binlookup?bin=";
const logBox = document.getElementById("log");
const inputBox = document.getElementById("input");
const outputBox = document.getElementById("output");
const fileInput = document.getElementById("file");

function log(msg){ logBox.value += msg + "\\n"; logBox.scrollTop = logBox.scrollHeight; }

async function fetchBin(bin){
  try{
    const r = await fetch(API_BASE + encodeURIComponent(bin));
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }catch(e){
    log("âš ï¸ BIN "+bin+" : "+e.message);
    return null;
  }
}

function parseLines(text){
  const rawLines = text.split(/\\r?\\n/).map(l=>l.trim()).filter(Boolean);
  const result = [];
  for(const line of rawLines){
    // enlever les 8 premiers chiffres d'identifiant s'ils existent
    const cleaned = line.replace(/^\\d{8,}\\s*/, "");
    if(!cleaned.includes("|")){
      log("âš ï¸ IgnorÃ© : ligne sans sÃ©parateurs -> "+cleaned);
      continue;
    }
    result.push(cleaned);
  }
  return result;
}

function groupCard(num){
  return num.replace(/\\D/g,"").replace(/(\\d{4})(?=\\d)/g,"$1 ");
}

function formatBlock(carte, binInfo){
  const b = binInfo || {};
  const bank = (b.bank && b.bank.name) || "Non spÃ©cifiÃ©";
  const country = (b.country && b.country.name) || "Non spÃ©cifiÃ©";
  const scheme = b.scheme || "Non spÃ©cifiÃ©";
  const brand = b.brand || "Non spÃ©cifiÃ©";
  const type = b.type || "Non spÃ©cifiÃ©";

  return `ðŸ’³ +1 NOUVELLE FICHE
â”” ${groupCard(carte.CardNumber)}

ðŸ¦ Informations Personnelles
â”œ ðŸ•µï¸ Nom complet : ${carte.FullName}
â”œ ðŸ  Adresse : ${carte.Address}
â”œ ðŸ“® Zip : ${carte.Zip}
â”œ ðŸ¢ Ville : ${carte.City}
â”œ ðŸ“ž TÃ©lÃ©phone : ${carte.Phone}
â”” ðŸ“§ Email : ${carte.Email}

ðŸ¦ Carte de Paiement
â”œ ðŸ’ Titulaire : ${carte.FullName}
â”œ ðŸ’³ NumÃ©ro : ${groupCard(carte.CardNumber)}
â”œ ðŸ’³ BIN : ${carte.BIN}
â”œ ðŸ’³ RÃ©seau : ${scheme}
â”œ ðŸ’³ Banque : ${bank} (${country})
â”œ ðŸ’³ Niveau : ${brand}
â”œ ðŸ’³ Type : ${type}
â”œ ðŸ“… Expiration : ${carte.ExpMonth}/${carte.ExpYear}
â”” ðŸ”’ CVV : ${carte.CVV}
`;
}

async function processText(text){
  logBox.value = ""; outputBox.value = "";
  const lines = parseLines(text);
  if(lines.length===0){ alert("Aucune fiche valide trouvÃ©e."); return; }
  let finalOut = "";
  let i=0;
  for(const line of lines){
    i++;
    const parts = line.split("|").map(p=>p.trim());
    if(parts.length<4){ log("âš ï¸ Fiche #"+i+" incomplÃ¨te : "+line); continue; }
    while(parts.length<12) parts.push("");
    const carte={
      CardNumber:parts[0],ExpMonth:parts[1],ExpYear:parts[2],CVV:parts[3],
      BankField:parts[4],FullName:parts[5],Address:parts[6],
      City:parts[7],City2:parts[8],Zip:parts[9],Phone:parts[10],Email:parts[11]
    };
    const digits = carte.CardNumber.replace(/\\D/g,"");
    if(digits.length<6){ log("âš ï¸ Fiche #"+i+" carte trop courte."); continue; }
    carte.BIN = digits.slice(0,6);
    log("Traitement fiche #"+i+" (BIN "+carte.BIN+")...");
    const binInfo = await fetchBin(carte.BIN);
    finalOut += formatBlock(carte,binInfo) + "\\n";
    await new Promise(r=>setTimeout(r,150));
  }
  outputBox.value = finalOut.trim();
  log("âœ… Traitement terminÃ©. "+lines.length+" fiches analysÃ©es.");
}

document.getElementById("process").addEventListener("click", async()=>{
  const txt = inputBox.value.trim();
  if(txt) await processText(txt);
  else if(fileInput.files.length>0){
    const file = fileInput.files[0];
    const text = await file.text();
    await processText(text);
  }else alert("Colle ton texte ou ajoute un fichier .txt.");
});

document.getElementById("download").addEventListener("click",()=>{
  const t = outputBox.value;
  if(!t){ alert("Rien Ã  tÃ©lÃ©charger."); return; }
  const blob = new Blob([t],{type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "LIGHTRI_result.txt";
  document.body.appendChild(a);
  a.click();
  a.remove();
});
</script>
</body>
</html>