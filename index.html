<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LIGHTRI ‚Äî Nettoyage robuste & logs</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f8f9fb;color:#111;margin:0;padding:20px}
h1{margin:0 0 8px 0;font-weight:600}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
textarea,input,button,label{font-family:inherit;font-size:15px}
textarea{width:100%;height:200px;padding:10px;border-radius:8px;border:1px solid #ccc;resize:vertical;background:#fff;color:#111}
button{padding:8px 12px;border-radius:8px;border:1px solid #999;background:#fff;cursor:pointer}
.note{font-size:13px;color:#666;margin-bottom:8px}
.progress{height:12px;background:#eee;border-radius:8px;overflow:hidden;margin:8px 0}
.progress>.bar{height:12px;background:#4caf50;width:0%;transition:width .18s linear}
#cardsGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(720px,1fr));gap:12px;margin-top:16px}
.cardWrap{background:#fff;border-radius:10px;padding:12px;border:1px solid #e6e6e6;display:flex;flex-direction:column;gap:8px}
.cardText{white-space:pre-wrap;font-family:inherit;font-size:14px;color:#111;line-height:1.35}
#errorLog{height:160px;background:#fff8f8;border:1px solid #f2a1a1;padding:8px;overflow:auto;font-size:13px;color:#900;white-space:pre-wrap;margin-top:12px;border-radius:6px;}
.small{font-size:13px;color:#666;margin-left:8px}
.check{display:flex;align-items:center;gap:6px}
</style>
</head>
<body>
<h1>üí≥ LIGHTRI ‚Äî Nettoyage robuste</h1>

<div class="note">
  - Ce script nettoie les caract√®res invisibles (non‚Äëbreaking spaces, zero‚Äëwidth, etc.) et extrait uniquement les chiffres.<br>
  - Si apr√®s extraction il y a <code>&lt; 6</code> chiffres, la fiche sera ignor√©e sauf si tu coches ¬´ Forcer le traitement ¬ª.<br>
  - Les erreurs d√©taill√©es (ligne originale + chiffres extraits) s'affichent dans le log d'erreurs.
</div>

<div class="controls">
  <input id="file" type="file" accept=".txt,.json" />
  <button id="process">Traiter</button>
  <button id="download">T√©l√©charger fiches</button>
  <button id="loadExample">Charger exemple</button>
  <label class="check"><input id="force" type="checkbox"/> <span class="small">Forcer le traitement m√™me si &lt; 6 chiffres</span></label>
</div>

<div class="small">Progr√®s <span id="counter">0/0</span> ‚Äî <span id="status">Pr√™t</span></div>
<div class="progress"><div class="bar" id="progressBar"></div></div>

<textarea id="input" placeholder="Colle ici ton texte brut..."></textarea>

<div id="cardsGrid"></div>

<div class="note">Erreurs / d√©tails :</div>
<div id="errorLog" aria-live="polite"></div>

<script>
/* ---------- CONFIG ---------- */
const BINLIST_BASE = 'https://lookup.binlist.net/';
const LOCAL_BINS_EMBEDDED = {
  "497040":{"bank":"CR√âDIT AGRICOLE","brand":"CLASSIC","type":"DEBIT","country":"France"},
  "513379":{"bank":"BNP PARIBAS","brand":"CLASSIC","type":"CREDIT","country":"France"},
  "553979":{"bank":"SOCIETE GENERALE","brand":"CLASSIC","type":"DEBIT","country":"France"}
};
window.__LOCAL_BINS = Object.assign({}, LOCAL_BINS_EMBEDDED);

/* ---------- UI refs ---------- */
const inputBox = document.getElementById('input');
const fileInput = document.getElementById('file');
const cardsGrid = document.getElementById('cardsGrid');
const progressBar = document.getElementById('progressBar');
const counterEl = document.getElementById('counter');
const statusEl = document.getElementById('status');
const errorLog = document.getElementById('errorLog');
const forceCheckbox = document.getElementById('force');

/* ---------- Helpers robust cleaning ---------- */

/* normalizeWhitespace:
   - replace various unicode whitespace / invisible chars with normal space or remove
   - trim ends
*/
function normalizeWhitespace(s){
  if(!s) return '';
  // remove zero-width and BOM and other invisible chars
  s = s.replace(/[\u200B-\u200F\uFEFF]/g, '');
  // replace non-breaking spaces and many unicode spaces with normal space
  s = s.replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g,' ');
  // collapse multiple spaces/tabs
  s = s.replace(/\s+/g,' ').trim();
  return s;
}

/* digitsOnly: extract digits only (0-9) */
function digitsOnly(s){
  if(!s) return '';
  // first normalize to remove invisible whitespace that might break things
  s = normalizeWhitespace(s);
  // then remove every non-digit
  return s.replace(/\D/g,'');
}

/* logging */
function logError(msg){
  const time = new Date().toLocaleTimeString();
  errorLog.textContent += `[${time}] ${msg}\n`;
  errorLog.scrollTop = errorLog.scrollHeight;
}

/* group card visually */
function groupCard(num){ return digitsOnly(num).replace(/(\d{4})(?=\d)/g,'$1 '); }

/* fetch bin info (local first, fallback to binlist) */
async function fetchBinInfo(bin){
  if(!bin) return { bankName:'Non sp√©cifi√©', brand:'CLASSIC', type:'CREDIT', country:'' };
  try{
    if(window.__LOCAL_BINS && window.__LOCAL_BINS[bin]){
      const v = window.__LOCAL_BINS[bin];
      return {
        bankName: v.bank || v.bank_name || v.bankName || 'Non sp√©cifi√©',
        brand: v.brand || v.level || v.scheme || 'CLASSIC',
        type: (v.type || '').toUpperCase() || 'CREDIT',
        country: v.country || ''
      };
    }
  }catch(e){
    // ignore
  }
  try{
    const res = await fetch(BINLIST_BASE + encodeURIComponent(bin), { headers: { 'Accept-Version':'3' }});
    if(!res.ok){
      logError(`BIN ${bin} non trouv√© sur Binlist (HTTP ${res.status}) ‚Äî fallback valeurs par d√©faut.`);
      return { bankName:'Non sp√©cifi√©', brand:'CLASSIC', type:'CREDIT', country:'' };
    }
    const j = await res.json();
    return {
      bankName: j.bank?.name || j.bank || 'Non sp√©cifi√©',
      brand: j.brand || j.scheme || 'CLASSIC',
      type: (j.type || '').toUpperCase() || 'CREDIT',
      country: j.country?.alpha2 || j.country?.name || ''
    };
  }catch(err){
    logError(`Erreur fetch Binlist ${bin} : ${err.message}`);
    return { bankName:'Non sp√©cifi√©', brand:'CLASSIC', type:'CREDIT', country:'' };
  }
}

/* build fiche text (with real newlines) */
function buildFicheText(carte, binInfo){
  const lines = [];
  lines.push('üí≥ +1 IMPO.UHQ');
  lines.push('‚îî ' + groupCard(carte.CardNumber));
  lines.push('');
  lines.push('üè¶ Informations Personnelles');
  lines.push('‚îú üïµÔ∏è Nom complet : ' + (carte.FullName || ''));
  lines.push('‚îú üè† Adresse : ' + (carte.Address || ''));
  lines.push('‚îú üìÆ Zip : ' + (carte.Zip || ''));
  lines.push('‚îú üè¢ Ville : ' + (carte.City || ''));
  lines.push('‚îú üìû Num√©ro de t√©l√©phone : ' + (carte.Phone || ''));
  lines.push('‚îî üìß Email : ' + (carte.Email || 'Non fourni'));
  lines.push('');
  lines.push('üè¶ Carte de Paiement');
  lines.push('‚îú üçí Titulaire : ' + (carte.FullName || ''));
  lines.push('‚îú üí≥ Num√©ro de carte : ' + groupCard(carte.CardNumber));
  lines.push('‚îú üí≥ Bin : ' + (carte.BIN || ''));
  lines.push('‚îú üí≥ Banque : ' + (binInfo.bankName || carte.BankField || 'Non sp√©cifi√©'));
  lines.push('‚îú üí≥ Niveau : ' + (binInfo.brand || 'CLASSIC').toString().toUpperCase());
  lines.push('‚îú üí≥ Type : ' + (binInfo.type || 'CREDIT').toString().toUpperCase());
  lines.push('‚îú üìÖ Expiration : ' + (carte.ExpMonth || '') + '/' + (carte.ExpYear || ''));
  lines.push('‚îî üîí Cryptogramme visuel : ' + (carte.CVV || ''));
  return lines.join('\n');
}

/* parse lines robustly */
function parseLines(text){
  const rows = text.split(/\r?\n/);
  const out = [];
  for(let rawLine of rows){
    const line = rawLine.trim();
    if(!line) continue;
    // apply whitespace normalization (keeps separators)
    const cleaned = normalizeWhitespace(line);
    if(!cleaned.includes('|')){
      logError(`Ignor√© (pas de s√©parateur "|") : "${line}"`);
      continue;
    }
    out.push(cleaned);
  }
  return out;
}

/* main processing with detailed logs about extracted digits */
async function processText(raw){
  cardsGrid.innerHTML = '';
  errorLog.textContent = '';
  setStatus('Traitement...');
  const lines = parseLines(raw);
  if(lines.length === 0){ setStatus('Aucune fiche'); return; }
  let done = 0;
  const total = lines.length;
  updateProgress(done,total);

  const BATCH = 6;
  for(let i=0;i<lines.length;i+=BATCH){
    const batch = lines.slice(i, i+BATCH);
    await Promise.all(batch.map(async (line) => {
      // split into parts
      const parts = line.split('|').map(p => p.trim());
      while(parts.length < 12) parts.push('');
      const carte = {
        CardNumber: parts[0],
        ExpMonth: parts[1],
        ExpYear: parts[2],
        CVV: parts[3],
        BankField: parts[4],
        FullName: parts[5],
        Address: parts[6],
        City: parts[7],
        Region: parts[8],
        Zip: parts[9],
        Phone: parts[10],
        Email: parts[11]
      };

      // extract digits robustly
      const digits = digitsOnly(carte.CardNumber);
      if(digits.length < 6){
        logError(`Carte ignor√©e (trop courte pour BIN) ‚Äî ligne: "${line}" | chiffres extraits: "${digits}" (len=${digits.length})`);
        if(!forceCheckbox.checked){
          done++; updateProgress(done,total);
          return;
        } else {
          // force: proceed but BIN will be empty and bin lookup skipped
          logError(`‚Üí Forc√© : cr√©ation de fiche sans BIN pour la ligne ci‚Äëdessus.`);
        }
      }

      carte.BIN = digits.length >= 6 ? digits.slice(0,6) : '';

      // fetch bin info if we have a BIN
      const binInfo = carte.BIN ? await fetchBinInfo(carte.BIN) : { bankName:'Non sp√©cifi√©', brand:'CLASSIC', type:'CREDIT', country:'' };

      // build fiche and append
      const ficheText = buildFicheText(carte, binInfo);
      const wrap = document.createElement('div'); wrap.className = 'cardWrap';
      const txt = document.createElement('div'); txt.className = 'cardText'; txt.textContent = ficheText;
      wrap.appendChild(txt);
      cardsGrid.appendChild(wrap);

      done++; updateProgress(done,total);
    }));
    await new Promise(r => setTimeout(r, 120));
  }

  setStatus('Termin√© ‚Äî ' + total + ' fiches.');
}

/* UI wiring */
function setStatus(s){ statusEl.textContent = s; }
function updateProgress(done,total){ counterEl.textContent = `${done}/${total}`; progressBar.style.width = total ? Math.round((done/total)*100) + '%' : '0%'; }

/* buttons */
document.getElementById('process').addEventListener('click', ()=> processText(inputBox.value.trim()));
document.getElementById('download').addEventListener('click', ()=>{
  const texts = Array.from(document.querySelectorAll('.cardText')).map(n => n.textContent);
  if(!texts.length){ alert('Rien √† t√©l√©charger'); return; }
  const blob = new Blob([texts.join('\n\n')], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'LIGHTRI_fiches.txt'; document.body.appendChild(a); a.click(); a.remove();
});
document.getElementById('loadExample').addEventListener('click', ()=>{
  inputBox.value = [
    "4970 4071 0938 6230 | 01 | 2026 | 116 | CR√âDIT AGRICOLE | Remi Vallette | 18 avenue linn | Savigny sur orge | Ile-de-France | 91600 | 0684204360 | remi.vallette@gmail.com",
    "5133791059685621 | 02 | 2026 | 500 | BNP PARIBAS | Dicanot | 42 boulevard Dubreuil | Bures-sur-Yvette | Essonne | 91440 | 0782714931 | idicanot@gmail.com",
    "5539791646892300 | 12 | 2025 | 257 | SOCIETE GENERALE | Kelly Yang | 23 Rue Paul Auster | Thiais | Val-de-Marne | 94320 | 0652894389 | kellyyang@outlook.fr"
  ].join('\n');
  processText(inputBox.value);
});

/* file load */
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  // if json, attempt to load local bins mapping
  if(f.name.toLowerCase().endsWith('.json')){
    try{
      const txt = await f.text();
      const parsed = JSON.parse(txt);
      if(parsed && typeof parsed === 'object'){
        window.__LOCAL_BINS = parsed;
        alert('bins.json local charg√© et utilis√© en priorit√© pour lookups.');
      } else alert('JSON bins invalide (attendu mapping BIN->info).');
    }catch(err){ alert('Erreur lecture JSON: ' + err.message); }
    return;
  }
  const txt = await f.text();
  inputBox.value = txt;
  processText(txt);
});
</script>
</body>
</html>